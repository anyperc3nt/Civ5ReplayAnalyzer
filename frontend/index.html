<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Civ5 Replay (PixiJS)</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PixiJS 7 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', sans-serif; color: #eee; }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è PixiJS */
        #pixi-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        /* UI –°–ª–æ–π */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }

        /* –ü–∞–Ω–µ–ª–∏ */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            height: 50px; /* –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –í–´–°–û–¢–ê */
            background: rgba(20, 20, 25, 0.95);
            border-bottom: 1px solid #444;
            padding: 0 20px; /* Padding —Ç–æ–ª—å–∫–æ –ø–æ –±–æ–∫–∞–º */
            display: flex; justify-content: space-between; align-items: center;
            box-sizing: border-box; /* –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤—ã—Å–æ—Ç—ã */
        }

        /* –í—Å–µ –º–æ–¥–∞–ª–∫–∏ –∏ –±–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –æ—Ç—Å—Ç—É–ø–∞—é—Ç —Ä–æ–≤–Ω–æ –Ω–∞ 50px */
        .modal-layer, .side-panel {
            position: absolute; top: 50px; bottom: 0;
        }

        .side-panel {
            right: 0; width: 280px;
            background: rgba(20, 20, 25, 0.9);
            border-left: 1px solid #444;
            display: flex; flex-direction: column;
            overflow-y: auto;
        }

        .modal-layer {
            left: 0; right: 0;
            background: rgba(10,12,16, 0.96);
            z-index: 50;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã */
        button { background: #444; border: 1px solid #666; color: white; padding: 4px 10px; cursor: pointer; border-radius: 3px; font-size: 13px; }
        button:hover { background: #555; }
        button.active { background: #d44; border-color: #f66; } /* –ê–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
        
        input[type=range] { width: 300px; }

        .stat-row { padding: 6px 12px; border-bottom: 1px solid #333; font-size: 13px; display: flex; justify-content: space-between; }
        .stat-row:hover { background: rgba(255,255,255,0.05); }

        /* –ò–∫–æ–Ω–∫–∏ Yields */
        .yield-icon {
            width: 17px; height: 17px;
            display: inline-block; vertical-align: middle;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            margin-top: -2px;
        }
        .icon-food { background-image: url('assets/UI/icon_food.png'); }
        .icon-prod { background-image: url('assets/UI/icon_production.png'); }
        .icon-gold { background-image: url('assets/UI/icon_gold.png'); }
        .icon-sci  { background-image: url('assets/UI/icon_science.png'); }
        .icon-cult { background-image: url('assets/UI/icon_culture.png'); }
        .icon-faith { background-image: url('assets/UI/icon_faith.png'); }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
    </style>
</head>
<body>

<div id="app">
    <!-- –°—é–¥–∞ Pixi –¥–æ–±–∞–≤–∏—Ç Canvas -->
    <div id="pixi-container"></div>

    <!-- UI Vue.js -->
    <div id="ui-layer" v-if="loaded">
        <div class="top-bar interactive">
            <div>
                <b>Civ5 Replay</b> <span style="font-size: 0.8em; color: #888;">{{ currentTurnData?.timestamp ? new Date(currentTurnData.timestamp * 1000).toLocaleTimeString() : '' }}</span>
            </div>

            <button @click="togglePanel('tech')" :class="{active: activePanel==='tech'}">
                <span class="yield-icon icon-sci"></span> Tech
            </button>
            <button @click="togglePanel('culture')" :class="{active: activePanel==='culture'}">
                <span class="yield-icon icon-cult"></span> Culture
            </button>
            <button @click="togglePanel('faith')" :class="{active: activePanel==='faith'}">
                <span class="yield-icon icon-faith"></span> Faith
            </button>
            <button @click="togglePanel('builds')" :class="{active: activePanel==='builds'}">
                <span class="yield-icon icon-prod"></span> Build
            </button>
            <button @click="togglePanel('charts')" :class="{active: activePanel==='charts'}">
                üìà Charts
            </button>

            <div style="display: flex; gap: 10px; align-items: center;">
                <button @click="changeTurn(-1)">‚èÆ</button>
                <div style="width: 50px; text-align: center; font-size: 20px; font-weight: bold;">{{ currentTurn }}</div>
                <button @click="changeTurn(1)">‚è≠</button>
                <input type="range" min="0" :max="maxTurns" v-model.number="currentTurn" @input="updateMap">
            </div>

            <div style="margin-left: 20px; display: flex; align-items: center; gap: 5px;">
                <label style="font-size: 13px; cursor: pointer; user-select: none;">
                    <input type="checkbox" v-model="showYields" @change="updateMap"> Show Yields
                </label>
            </div>

            <div style="margin-left: 20px; display: flex; gap: 5px;">
                <button @click="iconMode = 'default'" :style="{background: iconMode==='default'?'#66a':''}">All</button>
                <button @click="iconMode = 'military'" :style="{background: iconMode==='military'?'#66a':''}">‚öîÔ∏è</button>
                <button @click="iconMode = 'civilian'" :style="{background: iconMode==='civilian'?'#66a':''}">üë∑</button>
                <button @click="iconMode = 'resource'" :style="{background: iconMode==='resource'?'#66a':''}">üíé</button>
                <button @click="iconMode = 'misc'" :style="{background: iconMode==='misc'?'#66a':''}">üóø</button>
            </div>

            <button @click="showPlayerList = !showPlayerList" :style="{background: showPlayerList?'#666':''}" title="Toggle Player List">
                ‚ò∞
            </button>
        </div>

        <div class="side-panel interactive" v-if="showPlayerList">
            
            <!-- === MAJOR PLAYERS === -->
            <div style="padding: 10px; background: #222; font-weight: bold; border-bottom: 1px solid #444; color: #ddd;">
                Civilizations
            </div>
            
            <div v-for="player in visiblePlayers" :key="player.id" style="border-bottom: 1px solid #333;">
                
                <!-- –°—Ç—Ä–æ–∫–∞ –ò–≥—Ä–æ–∫–∞ (–ö–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è) -->
                <div class="stat-row" @click="togglePlayerExpand(player.id)" style="cursor: pointer; background: rgba(255,255,255,0.02);">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <!-- –°—Ç—Ä–µ–ª–æ—á–∫–∞ -->
                        <span style="font-size: 10px; color: #888; width: 10px;">
                            {{ expandedPlayerIds.includes(player.id) ? '‚ñº' : '‚ñ∂' }}
                        </span>
                        
                        <!-- –¶–≤–µ—Ç -->
                        <div :style="{width:'12px', height:'12px', borderRadius:'50%', background: getPlayerColor(player.id)}"></div>
                        
                        <!-- –ò–º—è -->
                        <div style="display: flex; flex-direction: column;">
                            <span style="font-weight: bold; font-size: 0.95em;">{{ getCivilizationName(player.id) }}</span>
                        </div>
                    </div>

                    <!-- –°—Ç–∞—Ç—ã (–ö—Ä–∞—Ç–∫–æ) -->
                    <div style="text-align: right; font-size: 0.8em; color: #aaa;">
                        <span class="yield-icon icon-sci"></span> {{ player.science }}
                        <span class="yield-icon icon-gold" style="margin-left:5px;"></span> {{ Math.floor(player.gold) }}
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ –∏–≥—Ä–æ–∫–∞ (–í—ã–ø–∞–¥–∞—é—â–∏–π) -->
                <div v-if="expandedPlayerIds.includes(player.id)" style="background: rgba(0,0,0,0.3); box-shadow: inset 0 0 10px rgba(0,0,0,0.5);">
                    <div v-for="city in (citiesByPlayer[player.id] || [])" :key="city.id" 
                         @click.stop="jumpToCity(city)"
                         style="padding: 6px 10px 6px 35px; border-bottom: 1px solid #2a2a2a; font-size: 0.9em; color: #ccc; cursor: pointer; display: flex; justify-content: space-between;">
                        
                        <span>
                            <span v-if="city.isCapital" title="Capital">‚≠ê</span>
                            {{ city.name }}
                        </span>
                        <span style="color: #666; font-size: 0.9em;">{{ city.pop }}</span>
                    </div>
                    <div v-if="!(citiesByPlayer[player.id] || []).length" style="padding: 5px 35px; color: #666; font-size: 0.8em; font-style: italic;">
                        –ù–µ—Ç –≥–æ—Ä–æ–¥–æ–≤
                    </div>
                </div>
            </div>

            <!-- === CITY STATES === -->
            <div style="padding: 10px; margin-top: 10px; background: #222; font-weight: bold; border-bottom: 1px solid #444; border-top: 1px solid #444; color: #ddd;">
                City-States
            </div>
            
            <div v-for="cs in minorPlayers" :key="cs.id" class="stat-row" style="opacity: 0.8;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width:10px; height:10px; background: #444; border: 1px solid #888; border-radius: 50%;"></div>
                    <span>{{ getCivilizationName(cs.id) }}</span>
                </div>
                <!-- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å (Friend/Ally) –µ—Å–ª–∏ –±—É–¥–µ–º —Ç–∞—â–∏—Ç—å –∏–∑ Lua -->
            </div>
             <div v-if="minorPlayers.length === 0" style="padding: 10px; color: #666; font-style: italic;">
                –ù–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ì–ì
            </div>

        </div>
        <!-- TECH TREE MODAL -->
        <div v-if="activePanel==='tech'" class="interactive modal-layer">

            <!-- –õ–ï–ì–ï–ù–î–ê (–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–ª–∞—à–∫–∞ —Å–≤–µ—Ä—Ö—É –∏–ª–∏ —Å–±–æ–∫—É) -->
            <div style="position: fixed; bottom: 20px; left: 10px; z-index: 100; display: flex; gap: 10px; pointer-events: none;">
                <div v-for="p in visiblePlayers.filter(x=>!x.isMinor)" :key="p.id" 
                     style="background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 4px; border: 1px solid #555; display: flex; align-items: center; gap: 5px;">
                    <div :style="{width:'10px', height:'10px', background: getPlayerColor(p.id)}"></div>
                    <span style="font-size: 12px; color: #fff;">{{ getCivilizationName(p.id) }}</span>
                </div>
            </div>
            
            <!-- 1. –°–õ–û–ô –°–í–Ø–ó–ï–ô (SVG) -->
            <svg style="position: absolute; top:0; left:0; width: 100%; height: 100%; pointer-events: none;">
                <path v-for="(link, i) in techTreeLinks" :key="i"
                    :d="`M ${link.x1} ${link.y1} C ${link.x1+30} ${link.y1}, ${link.x2-30} ${link.y2}, ${link.x2} ${link.y2}`"
                    stroke="#555" stroke-width="2" fill="none" />
            </svg>

            <!-- 2. –°–õ–û–ô –ö–ê–†–¢–û–ß–ï–ö -->
            <div v-for="node in techTreeNodes" :key="node.id" 
                 :style="{
                    position: 'absolute',
                    left: node.x + 'px',
                    top: node.y + 'px',
                    width: '180px',
                    height: '60px',
                    background: '#222',
                    border: '1px solid #444',
                    borderRadius: '4px',
                    padding: '4px',
                    fontSize: '11px',
                    color: '#eee',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.5)',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'space-between'
                 }">
                
                <!-- –í–µ—Ä—Ö: –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –¶–µ–Ω–∞ -->
                <div style="display: flex; justify-content: space-between;">
                    <div style="font-weight: bold; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 130px;" :title="node.name">
                        {{ node.name }}
                    </div>
                    <div style="color: #888; font-size: 10px;">{{ node.cost }}</div>
                </div>

                <!-- –ù–∏–∑: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏–≥—Ä–æ–∫–æ–≤ (–ß–∏–ø—ã) -->
                <div style="display: flex; gap: 2px; height: 12px; margin-top: auto;">
                    <div v-for="ps in node.playerStatuses" :key="ps.id" 
                         :title="getCivilizationName(ps.id) + ': ' + ps.status"
                         :style="{
                            flex: 1,
                            borderRadius: '2px',
                            // –õ–û–ì–ò–ö–ê –¶–í–ï–¢–û–í
                            background: ps.status === 'researched' ? ps.color : 
                                        ps.status === 'current' ? 'transparent' : '#333',
                            
                            border: ps.status === 'current' ? ('2px solid ' + ps.color) : 
                                    ps.status === 'none' ? '1px solid #333' : '1px solid ' + ps.color,
                            
                            opacity: ps.status === 'none' ? 0.3 : 1
                         }">
                    </div>
                </div>

            </div>

        </div>
        <!-- CULTURE MODAL -->
        <div v-if="activePanel==='culture'" class="interactive modal-layer" style="padding: 20px; flex-direction: row; gap: 20px;">
            <div v-for="p in visiblePlayers.filter(x => !x.isMinor)" :key="p.id" style="min-width: 250px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–≥—Ä–æ–∫–∞ -->
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 2px solid #444; padding-bottom: 5px;">
                    <div :style="{width:'16px', height:'16px', borderRadius:'50%', background: getPlayerColor(p.id)}"></div>
                    <b style="font-size: 1.2em;">{{ getCivilizationName(p.id) }}</b>
                    <div style="margin-left: auto; color: #d0f;">üéµ {{ Math.floor(p.totalCulture) }}</div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –≤–µ—Ç–æ–∫ -->
                <div v-if="playerPoliciesGrouped[p.id]">
                    <div v-for="(pols, branchName) in playerPoliciesGrouped[p.id]" :key="branchName" style="margin-bottom: 15px;">
                        <div style="color: #aaa; text-transform: uppercase; font-size: 0.85em; margin-bottom: 5px; border-bottom: 1px solid #333;">
                            {{ branchName }}
                        </div>
                        <div v-for="polName in pols" :key="polName" style="padding-left: 10px; font-size: 0.95em; color: #ddd;">
                            ‚Ä¢ {{ polName }}
                        </div>
                    </div>
                </div>
                <div v-else style="color: #666; font-style: italic;">–ù–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –ø–æ–ª–∏—Ç–∏–∫</div>
            </div>
        </div>
        <!-- RELIGION MODAL -->
        <div v-if="activePanel==='faith'" class="interactive modal-layer" style="padding: 30px; flex-direction: row; flex-wrap: wrap; gap: 30px; justify-content: center;">
        <div v-for="p in religiousPlayers" :key="p.id" style="
            width: 320px; 
            background: #222; 
            border: 1px solid #666; 
            border-radius: 6px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            display: flex; flex-direction: column;
            overflow: hidden;
        ">
            <!-- –®–∞–ø–∫–∞: –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –µ—Å–ª–∏ —ç—Ç–æ –ü–∞–Ω—Ç–µ–æ–Ω -->
            <div :style="{
                background: p.religion.type === 'PANTHEON' ? '#443' : '#222', 
                padding: '12px', 
                borderBottom: '1px solid #666', 
                textAlign: 'center',
                borderTop: '4px solid ' + getPlayerColor(p.id)
            }">
                <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                <div style="font-size: 1.4em; font-weight: bold; color: white;">
                    <span v-if="p.religion.type === 'PANTHEON'">‚ö° </span>
                    <span v-else><span class="yield-icon icon-faith"></span> </span>
                    {{ p.religion.name }}
                </div>
                
                <!-- –ü–æ–¥–ø–∏—Å—å –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—è -->
                <div style="font-size: 0.9em; color: #ccc; margin-top: 5px;">
                    {{ getCivilizationName(p.id) }}
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å -->
                <div v-if="p.religion.type === 'PANTHEON'" style="font-size: 0.75em; color: #aaa; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px;">
                    (Pantheon only)
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –í–µ—Ä–æ–≤–∞–Ω–∏–π -->
            <div style="padding: 15px; flex: 1; background: rgba(0,0,0,0.2);">
                <div v-for="bId in p.religion.beliefs" :key="bId" style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #444;">
                    <div v-if="replayData.header.dictionary.beliefs[bId]">
                        <div style="color: #eec; font-weight: bold; font-size: 1em; margin-bottom: 4px;">
                            {{ replayData.header.dictionary.beliefs[bId].name }}
                        </div>
                        <div style="color: #bbb; font-size: 0.85em; line-height: 1.35; font-style: italic;">
                            {{ replayData.header.dictionary.beliefs[bId].desc }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="religiousPlayers.length === 0" style="color: #888; margin-top: 50px; font-size: 1.5em; width: 100%; text-align: center;">
            –ù–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞–Ω—Ç–µ–æ–Ω–æ–≤ –∏ —Ä–µ–ª–∏–≥–∏–π
        </div>
        </div>

        <!-- BUILD ORDER MODAL -->
        <div v-if="activePanel==='builds'" :key="buildPanelKey" class="interactive modal-layer">
                    
            <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (Header) -->
            <div style="height: 35px; background: #222; border-bottom: 1px solid #444; overflow: hidden; position: relative; flex-shrink: 0;" ref="timelineHeader">
                <div :style="{ width: timelineWidth + 'px', height: '100%', position: 'relative' }">
                    <div style="position: sticky; left: 0; width: 200px; height: 100%; background: #222; border-right: 1px solid #444; z-index: 20; color: #888; display: flex; align-items: center; padding-left: 10px; font-size: 12px;">
                        CITY / TURN
                    </div>

                    <!-- –õ–∏–Ω–µ–π–∫–∞ (—à–∞–≥ 42px) -->
                    <div v-for="i in Math.floor(maxTurns/10) + 1" :key="i" 
                        :style="{
                            position: 'absolute', 
                            left: ((i-1)*10 * 42 + 200) + 'px', 
                            color: '#888', fontSize: '11px', top: '8px', fontWeight: 'bold', 
                            borderLeft: '1px solid #444', height: '20px', paddingLeft: '4px'
                        }">
                        {{ (i-1)*10 }}
                    </div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Ç–µ–ª–æ (Body) -->
            <div style="flex: 1; overflow: auto;" ref="timelineBody" @scroll="syncScroll">
                <div :style="{ width: timelineWidth + 'px', position: 'relative' }">
                    
                    <div v-for="(pData, pId) in buildTimeline" :key="pId" style="margin-bottom: 10px;">
                        <!-- –ò–≥—Ä–æ–∫ -->
                        <div style="
                            position: sticky; left: 0; z-index: 15;
                            padding: 6px 10px; background: #333; color: white; 
                            border-bottom: 1px solid #444; border-top: 1px solid #444;
                            display:flex; align-items:center; gap:10px; width: 100%; box-sizing: border-box;
                        ">
                            <div :style="{width:'10px', height:'10px', background: pData.color}"></div>
                            <b>{{ pData.name }}</b>
                        </div>

                        <!-- –ì–æ—Ä–æ–¥–∞ -->
                        <div v-for="(city, cId) in pData.cities" :key="cId" style="position: relative; height: 45px; border-bottom: 1px solid #2a2a2a; background: #1a1a1a;">
                            
                            <!-- –ò–º—è –≥–æ—Ä–æ–¥–∞ -->
                            <div style="
                                position: sticky; left: 0; width: 200px; height: 100%; 
                                background: #1e1e1e; border-right: 1px solid #444; 
                                display: flex; align-items: center; padding-left: 20px; 
                                font-size: 12px; color: #ccc; z-index: 5;
                                box-shadow: 2px 0 5px rgba(0,0,0,0.3);
                            ">
                                {{ city.name }}
                            </div>

                            <!-- –õ–∏–Ω–∏—è –∂–∏–∑–Ω–∏ (startTurn * 42) -->
                            <div :style="{
                                position: 'absolute', 
                                left: (200 + city.startTurn * 42) + 'px', 
                                right: 0, top: '50%', height: '2px', background: '#333'
                            }"></div>

                            <!-- –°–æ–±—ã—Ç–∏—è (turn * 42) -->
                            <div v-for="(ev, idx) in city.events" :key="idx" 
                                @mouseenter="showTooltip($event, ev.name + ' (Turn ' + ev.turn + ')')"
                                @mousemove="moveTooltip($event)"
                                @mouseleave="hideTooltip()"
                                :style="{
                                    position: 'absolute',
                                    left: (200 + ev.turn * 42) + 'px',
                                    top: '5px',
                                    width: '40px', height: '35px', /* –£–≤–µ–ª–∏—á–∏–ª–∏ –∑–æ–Ω—É –∫–ª–∏–∫–∞ */
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    cursor: 'help',
                                    zIndex: ev.type === 'FOUND' ? 20 : 10 
                                }">

                                <div v-if="ev.type === 'FOUND'" style="width: 10px; height: 10px; background: #fff; transform: rotate(45deg); border: 2px solid #000;"></div>
                                <div v-else-if="ev.type === 'U'" :style="{width: '12px', height: '12px', borderRadius: '50%', background: pData.color, border: '1px solid #aaa'}"></div>
                                <div v-else :style="{width: '10px', height: '10px', borderRadius: '2px', background: '#555', border: '1px solid ' + pData.color}"></div>

                                <!-- –ü–æ–¥–ø–∏—Å—å: max-width 80px -->
                                <div style="
                                    position: absolute; top: 26px; 
                                    font-size: 10px; color: #888; 
                                    white-space: nowrap; pointer-events:none; 
                                    max-width: 80px; overflow: hidden; text-overflow: ellipsis; 
                                    text-align: center;
                                ">
                                    {{ ev.type === 'FOUND' ? '' : ev.name }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CUSTOM TOOLTIP -->
        <div v-if="tooltip.show" style="
            position: fixed; 
            left: 0; top: 0; 
            transform: translate(0, 0); /* –ò—Å–ø–æ–ª—å–∑—É–µ–º style binding –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç */
            background: rgba(0,0,0,0.9); border: 1px solid #777; 
            color: white; padding: 5px 8px; border-radius: 4px; font-size: 12px; pointer-events: none; z-index: 1000;
            white-space: nowrap;
        " :style="{ left: tooltip.x + 'px', top: tooltip.y + 'px' }">
            {{ tooltip.text }}
        </div>

        <!-- CHARTS MODAL -->
        <div v-if="activePanel==='charts'" class="interactive modal-layer" style="padding: 20px;">
        <!-- Controls -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px; justify-content: center;">
            <select v-model="currentChartMetric" @change="updateChart" style="
                padding: 8px; font-size: 16px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;
            ">
            <optgroup label="General">
                <option value="score">Score</option>
                <option value="totalPop">Population</option>
                <option value="happiness">Happiness</option>
                <option value="goldenAgeTurns">Golden Age (Turns)</option>
            </optgroup>

            <optgroup label="Economy">
                <option value="gold">Total Gold</option>
                <option value="goldPerTurn">Gold Per Turn</option>
                <option value="totalFood">Crop Yield (Food)</option>
                <option value="totalProd">Manufacturing (Prod)</option>
            </optgroup>

            <optgroup label="Science & Culture">
                <option value="techCount">Technologies Researched</option>
                <option value="science">Science (Raw)</option>
                <option value="effectiveScience">Science (Effective)</option>
                <option value="totalCulture">Total Culture</option>
                <option value="culture">Culture (Raw)</option>
                <option value="effectiveCulture">Culture (Effective)</option>
                <option value="faith">Total Faith</option>
            </optgroup>

            <optgroup label="Military">
                <option value="military">Military Might</option>
            </optgroup>
            </select>
        </div>

        <!-- Chart Container -->
        <div style="flex: 1; position: relative; width: 100%; max-width: 1200px; margin: 0 auto;">
            <canvas id="replayChart"></canvas>
        </div>
        </div>

    </div>
    
    <div v-else style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white;">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
    </div>

        <!-- –û–∫–Ω–æ –≥–æ—Ä–æ–¥–∞ -->
    <div v-if="selectedCity" class="side-panel interactive" style="left: 0; right: auto; border-right: 1px solid #444; border-left: none;">
        <div style="padding: 10px; background: #222; display: flex; justify-content: space-between;">
            <b>{{ selectedCity.name }}</b>
            <button @click="closeCity">X</button>
        </div>
        
        <div style="padding: 10px;">
            <div class="stat-row">–ù–∞—Å–µ–ª–µ–Ω–∏–µ: <span style="color:white">{{ selectedCity.pop }}</span></div>
            <div class="stat-row">–ó–¥–æ—Ä–æ–≤—å–µ: <span style="color:lime">{{ selectedCity.hp }}</span></div>
            <div class="stat-row">
                üéØ –§–æ–∫—É—Å: 
                <span style="color: cyan; font-weight: bold;">
                    <span v-if="getFocusName(selectedCity.focus).icon" :class="'yield-icon ' + getFocusName(selectedCity.focus).icon"></span>
                    {{ getFocusName(selectedCity.focus).name }}
                </span>
            </div>

            <hr style="border-color: #444">
            
            <!-- YIELDS (–î–æ—Ö–æ–¥—ã) -->
            <div v-if="selectedCity.yields">
                <div class="stat-row"><span class="yield-icon icon-food"></span> –ï–¥–∞: <span>+{{ selectedCity.yields.food }}</span></div>
                <div class="stat-row"><span class="yield-icon icon-prod"></span> –ü—Ä–æ–∏–∑–≤: <span>+{{ selectedCity.yields.prod }}</span></div>
                <div class="stat-row"><span class="yield-icon icon-gold"></span> –ó–æ–ª–æ—Ç–æ: <span>+{{ selectedCity.yields.gold }}</span></div>
                <div class="stat-row"><span class="yield-icon icon-sci"></span> –ù–∞—É–∫–∞: <span>+{{ selectedCity.yields.sci }}</span></div>
                <div class="stat-row"><span class="yield-icon icon-cult"></span> –ö—É–ª—å—Ç: <span>+{{ selectedCity.yields.cult }}</span></div>
                <div class="stat-row"><span class="yield-icon icon-faith"></span> –í–µ—Ä–∞: <span>+{{ selectedCity.yields.faith }}</span></div>
            </div>

            <hr style="border-color: #444">
            <hr style="border-color: #444">

            <!-- –°–ü–ï–¶–ò–ê–õ–ò–°–¢–´ -->
            <div style="margin-bottom: 5px; color: #aaa;">–ì—Ä–∞–∂–¥–∞–Ω–µ:</div>
            
            <!-- –ë–µ–∑–¥–µ–ª—å–Ω–∏–∫–∏ -->
            <div v-if="selectedCity.slackers > 0" class="stat-row">
                üî¥ –ë–µ–∑—Ä–∞–±–æ—Ç–Ω—ã–µ: <span style="font-weight:bold;">{{ selectedCity.slackers }}</span>
            </div>

            <!-- –ó–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã -->
            <div v-if="selectedCity.specSlots && selectedCity.specSlots.length > 0">
                <div v-for="slot in selectedCity.specSlots" :key="slot.b" style="font-size: 0.9em; padding: 2px 0;">
                    <!-- –ò–º—è –∑–¥–∞–Ω–∏—è + –∫–æ–ª-–≤–æ —Å–ø–µ—Ü–æ–≤ -->
                    üèõÔ∏è {{ getBuildingName(slot.b) }}: 
                    <span style="color: yellow;">{{ slot.c }} üë§</span>
                </div>
            </div>

            <!-- –ü–†–û–ì–†–ï–°–° –í–ï–õ–ò–ö–ò–• –õ–Æ–î–ï–ô -->
            <div v-if="selectedCity.gpProgress && selectedCity.gpProgress.length > 0" style="margin-top: 10px;">
                <div style="color: #aaa; margin-bottom: 2px;">–í–µ–ª–∏–∫–∏–µ –ª—é–¥–∏:</div>
                <div v-for="gp in selectedCity.gpProgress" :key="gp.s" style="font-size: 0.8em; margin-bottom: 4px;">
                    <!-- –¢—É—Ç –º–æ–∂–Ω–æ –º–∞–ø–ø–∏—Ç—å ID —Å–ø–µ—Ü–∞ –Ω–∞ –∏–º—è, –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ ID -->
                    Spec {{ gp.s }}: 
                    <div style="background: #444; height: 4px; width: 100%; margin-top: 2px;">
                        <div :style="{width: (gp.p / gp.t * 100) + '%', background: 'cyan', height: '100%'}"></div>
                    </div>
                    <div style="text-align: right; color: #888;">{{ gp.p }} / {{ gp.t }}</div>
                </div>
            </div>
            <!-- –ü–†–û–ò–ó–í–û–î–°–¢–í–û -->
            <div style="text-align: center; margin-bottom: 10px; color: #aaa;">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ:</div>
            <div style="text-align: center; font-size: 1.1em; color: orange;">
                {{ selectedCity.prodItem || '–ù–∏—á–µ–≥–æ' }}
            </div>
            <div style="text-align: center; font-size: 0.9em;">
                (–û—Å—Ç–∞–ª–æ—Å—å —Ö–æ–¥–æ–≤: {{ selectedCity.prodTurns }})
            </div>

            <hr style="border-color: #444">
            
            <!-- –ó–î–ê–ù–ò–Ø -->
            <div style="margin-bottom: 5px; color: #aaa;">–ó–¥–∞–Ω–∏—è:</div>
            <div style="font-size: 0.85em; display: flex; flex-wrap: wrap; gap: 5px;">
                <span v-for="bId in selectedCity.buildings" :key="bId" style="background: #333; padding: 2px 5px; border-radius: 3px;">
                <!-- –¢—É—Ç –Ω—É–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è, –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ ID –∏–ª–∏ helper -->
                {{ getBuildingName(bId) }}
                </span>
            </div>
        </div>
    </div>

</div>


    
<script src="data.js"></script>
<script src="asset_map.js"></script>
<script src="js/viewer.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                loaded: false,
                currentTurn: 0,
                maxTurns: 0,
                replayData: null,
                selectedCityId: null,
                selectedCityOwner: null,
                
                iconMode: 'default',
                showYields: true,
                showPlayerList: true, // –≠—Ç–æ –æ—Å—Ç–∞–≤–∏–º –æ—Ç–¥–µ–ª—å–Ω—ã–º —Ñ–ª–∞–≥–æ–º, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ HUD, –∞ –Ω–µ –º–æ–¥–∞–ª–∫–∞
                
                // –í–ú–ï–°–¢–û –ö–£–ß–ò –§–õ–ê–ì–û–í:
                activePanel: null, // 'tech', 'culture', 'faith', 'builds', 'charts' –∏–ª–∏ null

                buildPanelKey: 0, 
                currentChartMetric: 'score',
                chartInstance: null,

                expandedPlayerIds: [],
                
                tooltip: { show: false, x: 0, y: 0, text: '' },
                playerColors: [0xda2020, 0x3366cc, 0xffcc00, 0x00aa00, 0xcc6600, 0x990099, 0x009999, 0xffffff]
            }
        },
        computed: {
            currentTurnData() { return this.replayData?.turns[this.currentTurn]; },
            currentPlayers() { return this.currentTurnData?.players || []; },

                // –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù–ù–´–ô –°–ü–ò–°–û–ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∞–Ω–µ–ª–∏
            visiblePlayers() {
                if (!this.currentPlayers) return [];
                // –§–∏–ª—å—Ç—Ä—É–µ–º: –ò–≥—Ä–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ò –Ω–µ –í–∞—Ä–≤–∞—Ä –ò –Ω–µ –ì–ì
                return this.currentPlayers.filter(p => p && !p.isBarbarian && !p.isMinor);
            },

            // –°–ø–∏—Å–æ–∫ –ì–æ—Ä–æ–¥–æ–≤-–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤ (Minor Civs)
            minorPlayers() {
                if (!this.currentPlayers) return [];
                return this.currentPlayers.filter(p => p && p.isMinor);
            },

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –ø–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–µ–Ω–¥–µ—Ä–∞
            // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç: { ownerId: [city1, city2], ... }
            citiesByPlayer() {
                const groups = {};
                this.currentCities.forEach(c => {
                    if (!groups[c.owner]) groups[c.owner] = [];
                    groups[c.owner].push(c);
                });
                return groups;
            },

            // –®–∏—Ä–∏–Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Ç–∞–π–º–ª–∞–π–Ω–∞ (—á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
            timelineWidth() {
                // 200px (–∏–º–µ–Ω–∞) + –∫–æ–ª-–≤–æ —Ö–æ–¥–æ–≤ * 42px + –∑–∞–ø–∞—Å
                return 200 + (this.maxTurns * 42) + 100;
            },        
            
            selectedCity() {
                if (this.selectedCityId === null || !this.currentTurnData) return null;
                return this.currentTurnData.cities.find(c => 
                    c.id === this.selectedCityId && 
                    c.owner === this.selectedCityOwner
                );
            },
            currentCities() {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ —Ö–æ–¥–∞ –∏–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
                return this.currentTurnData?.cities || [];
            },
            techTreeNodes() {
                if (!this.replayData) return [];
                const techs = this.replayData.header.dictionary.technologies;
                const nodes = [];
                
                const CELL_W = 220; 
                const CELL_H = 80;
                
                // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–∞–∂–æ—Ä–Ω—ã—Ö —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–π (–¥–ª—è –ø–æ—Ä—è–¥–∫–∞ —Å–ª–æ—Ç–æ–≤)
                // –§–∏–ª—å—Ç—Ä—É–µ–º: —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –Ω–µ –≤–∞—Ä–≤–∞—Ä—ã, –Ω–µ –ì–ì
                const majorPlayers = this.currentPlayers.filter(p => p && !p.isBarbarian && !p.isMinor);

                Object.keys(techs).forEach(key => {
                    const t = techs[key];
                    const techID = parseInt(key);
                    
                    // 2. –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞–∂–æ—Ä–∞
                    const playerStatuses = majorPlayers.map(p => {
                        let status = 'none'; // 'none', 'researched', 'current'
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ (p.tech –º–æ–∂–µ—Ç –±—ã—Ç—å null –≤ —Ä–∞–Ω–Ω–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –ª–æ–≥–≥–µ—Ä–∞)
                        if (p.tech) {
                            // –ê. –£–∂–µ –∏–∑—É—á–µ–Ω–æ
                            if (p.tech.researched && p.tech.researched.includes(techID)) {
                                status = 'researched';
                            }
                            // –ë. –ò–∑—É—á–∞–µ—Ç—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
                            else if (p.tech.current === techID) {
                                status = 'current';
                            }
                        }
                        
                        return {
                            id: p.id,
                            color: this.getPlayerColor(p.id),
                            status: status
                        };
                    });

                    nodes.push({
                        id: techID,
                        name: t.name,
                        cost: t.cost,
                        x: t.gridX * CELL_W, 
                        y: t.gridY * CELL_H, 
                        prereqs: t.prereqs,
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ —É–∑–µ–ª
                        playerStatuses: playerStatuses
                    });
                });
                
                return nodes;
            },
        
            // –°–≤—è–∑–∏ (–°—Ç—Ä–µ–ª–æ—á–∫–∏)
            techTreeLinks() {
                const links = [];
                const nodesMap = {};
                this.techTreeNodes.forEach(n => nodesMap[n.id] = n);
                
                const BOX_W = 180; // –®–∏—Ä–∏–Ω–∞ —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ (–º–µ–Ω—å—à–µ CELL_W)
                const BOX_H = 60;  // –í—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
                
                this.techTreeNodes.forEach(target => {
                    if (target.prereqs) {
                        target.prereqs.forEach(parentId => {
                            const source = nodesMap[parentId];
                            if (source) {
                                links.push({
                                    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è SVG –ª–∏–Ω–∏–∏
                                    x1: source.x + BOX_W, // –í—ã—Ö–æ–¥ —Å–ø—Ä–∞–≤–∞
                                    y1: source.y + BOX_H/2, // –°–µ—Ä–µ–¥–∏–Ω–∞ –≤—ã—Å–æ—Ç—ã
                                    x2: target.x,         // –í—Ö–æ–¥ —Å–ª–µ–≤–∞
                                    y2: target.y + BOX_H/2
                                });
                            }
                        });
                    }
                });
                return links;
            },
                // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ –ø–æ –≤–µ—Ç–∫–∞–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: { playerId: { 'Tradition': ['Aristocracy', ...], 'Liberty': [...] } }
            playerPoliciesGrouped() {
                if (!this.replayData || !this.visiblePlayers) return {};
                
                const dictPol = this.replayData.header.dictionary.policies;
                const dictBranch = this.replayData.header.dictionary.policyBranches;
                const res = {};

                this.visiblePlayers.forEach(p => {
                    if (!p.policies) return;
                    
                    const groups = {};
                    
                    p.policies.forEach(polId => {
                        const polDef = dictPol[polId];
                        if (polDef && polDef.branch) {
                            // –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –≤–µ—Ç–∫–∏ ("–¢—Ä–∞–¥–∏—Ü–∏—è") –∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ
                            const branchName = dictBranch[polDef.branch] || polDef.branch.replace('POLICY_BRANCH_', '');
                            
                            if (!groups[branchName]) groups[branchName] = [];
                            groups[branchName].push(polDef.name);
                        }
                    });
                    res[p.id] = groups;
                });
                return res;
            },
            
            // –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Ä–µ–ª–∏–≥–∏—è (–¥–ª—è –º–µ–Ω—é –†–µ–ª–∏–≥–∏–∏)
            religiousPlayers() {
                return this.visiblePlayers.filter(p => p.religion);
            },
            buildTimeline() {
                if (!this.replayData) return {};

                const data = {};
                const dict = this.replayData.header.dictionary;

                // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–∫–æ–≤ (–±–µ—Ä–µ–º –∏–∑ 0 —Ö–æ–¥–∞)
                const initialPlayers = this.replayData.turns[0]?.players || [];
                
                initialPlayers.forEach(p => {
                    if (!p.isMinor && !p.isBarbarian) {
                        data[p.id] = { 
                            name: p.civName || `Player ${p.id}`, 
                            color: this.getPlayerColor(p.id),
                            cities: {} 
                        };
                    }
                });

                // 2. –ü—Ä–æ—Ö–æ–¥ –ø–æ –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏
                this.replayData.turns.forEach(turn => {
                    const turnNum = turn.turn;

                    // –ê. –ì–æ—Ä–æ–¥–∞
                    if (turn.cities) {
                        turn.cities.forEach(c => {
                            const pData = data[c.owner];
                            if (pData) {
                                if (!pData.cities[c.id]) {
                                    pData.cities[c.id] = {
                                        name: c.name, 
                                        startTurn: turnNum,
                                        events: [
                                            {
                                                turn: turnNum,
                                                type: 'FOUND',
                                                name: 'City Founded',
                                                isCapture: false
                                            }
                                        ]
                                    };
                                }
                            }
                        });
                    }

                    // –ë. –°–æ–±—ã—Ç–∏—è
                    if (turn.events) {
                        turn.events.forEach(ev => {
                            const pData = data[ev.p];
                            if (pData && pData.cities[ev.c]) {
                                
                                let name = null;
                                let iconType = null;

                                if (ev.type === "B") {
                                    const def = dict.buildings[ev.id] || dict.buildings[String(ev.id)];
                                    name = def ? def.name : `Build #${ev.id}`;
                                } 
                                else if (ev.type === "U") {
                                    const def = dict.units[ev.id] || dict.units[String(ev.id)];
                                    if (def) {
                                        name = def.name;
                                        iconType = def.type;
                                    } else {
                                        name = `Unit #${ev.id}`;
                                    }
                                } 
                                else if (ev.type === 'FOUND') {
                                    name = 'Founded';
                                }

                                pData.cities[ev.c].events.push({
                                    turn: turnNum,
                                    type: ev.type,
                                    name: name,
                                    iconType: iconType
                                });
                            }
                        });
                    }
                });

                return data;
            },

        },
        watch: {
            // –ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
            iconMode() {
                window.setIconMode(this.iconMode); // –ú–µ—Ç–æ–¥ –≤ viewer.js
                this.updateMap();
            }
        },
        mounted() {
            window.appVue = this;
            if (window.REPLAY_DATA) {
                this.replayData = window.REPLAY_DATA;

                this.maxTurns = this.replayData.turns.length - 1;
    
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pixi
                window.initPixiApp(this.replayData);
                
                this.loaded = true;
            }
        },
        methods: {
            changeTurn(delta) {
                let next = this.currentTurn + delta;
                if (next >= 0 && next <= this.maxTurns) {
                    this.currentTurn = next;
                    this.updateMap();
                }
            },
            updateMap() {
                window.updatePixiTurn(this.currentTurn);
            },
            getPlayerColor(id) {
                if (id >= this.playerColors.length) return '#888888';
                return '#' + this.playerColors[id].toString(16).padStart(6, '0');
            },
            selectCity(cityId, ownerId) {
                this.selectedCityId = cityId;
                this.selectedCityOwner = ownerId;
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞
                if (this.selectedCity && window.highlightWorkedPlots) {
                    const ownerColor = parseInt(this.getPlayerColor(this.selectedCity.owner).replace('#', ''), 16);
                    
                    // !!! –ü–ï–†–ï–î–ê–ï–ú locked –ú–ê–°–°–ò–í –í–¢–û–†–´–ú –ê–†–ì–£–ú–ï–ù–¢–û–ú
                    // (–∏—Å–ø–æ–ª—å–∑—É–µ–º || [] –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –≤ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å—è—Ö)
                    window.highlightWorkedPlots(
                        this.selectedCity.worked || [], 
                        this.selectedCity.locked || [], 
                        ownerColor
                    );
                }
            },
            closeCity() {
                this.selectedCityId = null;
                this.selectedCityOwner = null;
                if (window.highlightWorkedPlots) window.highlightWorkedPlots([], [], 0);
            },
            togglePlayerExpand(pId) {
                const idx = this.expandedPlayerIds.indexOf(pId);
                if (idx === -1) this.expandedPlayerIds.push(pId);
                else this.expandedPlayerIds.splice(idx, 1);
            },

            jumpToCity(city) {
                // 1. –í—ã–¥–µ–ª—è–µ–º
                this.selectCity(city.id, city.owner);
                // 2. –î–≤–∏–≥–∞–µ–º –∫–∞–º–µ—Ä—É (–≤—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ viewer.js)
                if (window.moveCameraTo) {
                    window.moveCameraTo(city.x, city.y);
                }
            },            
            getBuildingName(id) {
                if (!this.replayData || !this.replayData.header.dictionary.buildings) return id;
                const def = this.replayData.header.dictionary.buildings[id];
                // –ë–µ—Ä–µ–º NAME –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                return def ? def.name : `Building #${id}`;
            },
            getCivilizationName(playerId) {
                if (playerId === 63) return "Barbarians";
                
                // –ò—â–µ–º –∏–≥—Ä–æ–∫–∞ –≤ —Ç–µ–∫—É—â–µ–º —Ö–æ–¥–µ
                const p = this.currentPlayers.find(pl => pl.id === playerId);
                if (!p) return `Player ${playerId}`;

                // –ï—Å–ª–∏ –µ—Å—Ç—å civName (Description), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (p.civName) return p.civName;

                // –§–æ–ª–±–µ–∫ –Ω–∞ —Å–ª–æ–≤–∞—Ä—å (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ civName –ø—É—Å—Ç–æ–π, –±–µ—Ä–µ–º Type –∏–∑ —Å–ª–æ–≤–∞—Ä—è)
                // –ù–æ p.civName (–∏–∑ Lua p:GetCivilizationDescription()) –æ–±—ã—á–Ω–æ –Ω–∞–¥–µ–∂–Ω–µ–µ
                return `Civ ${playerId}`;
            },
            getFocusName(focusId) {
                const modes = {
                    '-1': { name: "Default", icon: "" },
                    0: { name: "Food", icon: "icon-food" },
                    1: { name: "Production", icon: "icon-prod" },
                    2: { name: "Gold", icon: "icon-gold" },
                    3: { name: "Great People", icon: "" }, // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –∏–∫–æ–Ω–∫—É GP –ø–æ–∑–∂–µ
                    4: { name: "Science", icon: "icon-sci" },
                    5: { name: "Culture", icon: "icon-cult" },
                    8: { name: "Faith", icon: "icon-faith" }
                };
                return modes[focusId] || { name: `Unknown (${focusId})`, icon: "" };
            },
            syncScroll(e) {
                if (this.$refs.timelineHeader) {
                    this.$refs.timelineHeader.scrollLeft = e.target.scrollLeft;
                }
            },
            showTooltip(e, text) {
                this.tooltip.show = true;
                this.tooltip.text = text;
                this.moveTooltip(e);
            },
            moveTooltip(e) {
                // –°–¥–≤–∏–≥, —á—Ç–æ–±—ã –∫—É—Ä—Å–æ—Ä –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª
                this.tooltip.x = e.clientX + 15; 
                this.tooltip.y = e.clientY + 15;
            },
            hideTooltip() {
                this.tooltip.show = false;
            },
            togglePanel(name) {
                // 1. –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–∞–Ω–µ–ª–∏ - –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ—ë
                if (this.activePanel === name) {
                    this.activePanel = null;
                    return; 
                }

                // 2. –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
                this.activePanel = name;
                
                // === –°–ü–ï–¶–ò–§–ò–ß–ù–ê–Ø –õ–û–ì–ò–ö–ê ===

                // –î–ª—è –ì–†–ê–§–ò–ö–û–í: –∂–¥–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É DOM, –ø–æ—Ç–æ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Chart.js
                if (name === 'charts') {
                    this.$nextTick(() => {
                        this.updateChart();
                    });
                }

                // –î–ª—è BUILDS: –¢–æ—Ç —Å–∞–º—ã–π –•–ê–ö
                // –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏–∫—É: –º–µ–Ω—è–µ–º –∫–ª—é—á —á–µ—Ä–µ–∑ 50–º—Å –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è.
                // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç Vue –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø–∞–Ω–µ–ª–∏, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–≤ —Å–∫—Ä–æ–ª–ª—ã.
                if (name === 'builds') {
                    setTimeout(() => {
                        this.buildPanelKey++; 
                    }, 50);
                }
            },
            toggleCharts() {
                this.showCharts = !this.showCharts;
                if (this.showCharts) {
                    // –ñ–¥–µ–º –ø–æ–∫–∞ Vue –æ—Ç—Ä–∏—Å—É–µ—Ç DOM (canvas), –∑–∞—Ç–µ–º —Ä–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
                    this.$nextTick(() => {
                        this.updateChart();
                    });
                }
            },
            
            updateChart() {
                if (!this.replayData) return;
                const ctx = document.getElementById('replayChart');
                if (!ctx) return;
                if (this.chartInstance) this.chartInstance.destroy();

                const datasets = [];
                const turnsLabels = [];
                const playerMap = {};
                
                // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è (Golden Age)
                // Map: playerId -> cumulativeCounter
                const gaCounters = {}; 

                // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                const firstTurnPlayers = this.replayData.turns[0]?.players || [];
                firstTurnPlayers.forEach(p => {
                    if (!p.isMinor && !p.isBarbarian) {
                        playerMap[p.id] = {
                            label: this.getCivilizationName(p.id),
                            data: [],
                            borderColor: this.getPlayerColor(p.id),
                            backgroundColor: this.getPlayerColor(p.id),
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            fill: false,
                            tension: 0.1
                        };
                        gaCounters[p.id] = 0;
                    }
                });

                // –°–ª–æ–≤–∞—Ä—å –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Representation
                // –ò—â–µ–º ID –ø–æ–ª–∏—Ç–∏–∫–∏ POLICY_REPRESENTATION (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥)
                // –í –≤–∞–Ω–∏–ª—å–Ω–æ–π Civ5 BNW —ç—Ç–æ "POLICY_REPRESENTATION"
                let representationPolicyId = null;
                if (this.replayData.header.dictionary.policies) {
                    const dict = this.replayData.header.dictionary.policies;
                    const found = Object.keys(dict).find(k => dict[k].type === 'POLICY_REPRESENTATION');
                    if (found) representationPolicyId = parseInt(found);
                }

                // 2. –ü—Ä–æ—Ö–æ–¥ –ø–æ —Ö–æ–¥–∞–º
                this.replayData.turns.forEach((turn, idx) => {
                    turnsLabels.push(turn.turn);

                    Object.keys(playerMap).forEach(pId => {
                        const id = parseInt(pId);
                        const pData = turn.players ? turn.players.find(p => p.id === id) : null;
                        
                        let val = null; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é null (—Ä–∞–∑—Ä—ã–≤ –ª–∏–Ω–∏–∏)

                        if (pData && pData.isAlive) {
                            const m = this.currentChartMetric;
                            
                            // === –ü–†–û–°–¢–´–ï –ú–ï–¢–†–ò–ö–ò ===
                            if (m === 'score') val = pData.score;
                            else if (m === 'gold') val = pData.gold;
                            else if (m === 'goldPerTurn') val = pData.goldPerTurn;
                            else if (m === 'science') val = pData.science;
                            else if (m === 'totalCulture') val = pData.totalCulture;
                            else if (m === 'culture') val = pData.culture;
                            else if (m === 'faith') val = pData.faith;
                            else if (m === 'military') val = pData.military;
                            
                            // === –ù–û–í–´–ï –°–£–ú–ú–ê–†–ù–´–ï ===
                            else if (m === 'totalPop') val = pData.totalPop || 0;
                            else if (m === 'totalFood') val = pData.totalFood || 0;
                            else if (m === 'totalProd') val = pData.totalProd || 0;
                            else if (m === 'happiness') val = pData.happiness || 0;
                            
                            // === TECH COUNT ===
                            else if (m === 'techCount') {
                                val = pData.tech && pData.tech.researched ? pData.tech.researched.length : 0;
                            }

                            // === GOLDEN AGE (–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π) ===
                            else if (m === 'goldenAgeTurns') {
                                // –ï—Å–ª–∏ –≤ —ç—Ç–æ–º —Ö–æ–¥—É –∞–∫—Ç–∏–≤–µ–Ω GA, –ø–ª—é—Å—É–µ–º —Å—á–µ—Ç—á–∏–∫
                                if (pData.isGoldenAge) {
                                    gaCounters[id]++;
                                }
                                val = gaCounters[id];
                            }

                            // === EFFECTIVE SCIENCE ===
                            else if (m === 'effectiveScience') {
                                // –§–æ—Ä–º—É–ª–∞: Science / (1 + (NumCities - 1) * 0.05)
                                // –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç–æ–ª–∏—Ü—É (–ø–æ—ç—Ç–æ–º—É -1), –Ω–æ –Ω–µ –º–µ–Ω—å—à–µ 0
                                const numCitiesPen = Math.max(0, (pData.numCities || 1) - 1);
                                const penalty = 1 + (numCitiesPen * 0.05);
                                val = pData.science / penalty;
                            }

                            // === EFFECTIVE CULTURE ===
                            else if (m === 'effectiveCulture') {
                                // –ë–∞–∑–æ–≤—ã–π —à—Ç—Ä–∞—Ñ 10% –∑–∞ –≥–æ—Ä–æ–¥.
                                // –° –ø–æ–ª–∏—Ç–∏–∫–æ–π Representation: -33% –æ—Ç —à—Ç—Ä–∞—Ñ–∞ (—Ç.–µ. ~6.7%)
                                let perCityMod = 0.10;
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É
                                if (representationPolicyId && pData.policies && pData.policies.includes(representationPolicyId)) {
                                    perCityMod = 0.067; 
                                }

                                const numCitiesPen = Math.max(0, (pData.numCities || 1) - 1);
                                const penalty = 1 + (numCitiesPen * perCityMod);
                                val = pData.culture / penalty;
                            }
                        }

                        playerMap[id].data.push(val);
                    });
                });

                Object.values(playerMap).forEach(ds => datasets.push(ds));

                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels: turnsLabels, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { labels: { color: '#ccc' } },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            x: { ticks: { color: '#888' }, grid: { color: '#333' } },
                            y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: '#333' } }
                        }
                    }
                });
            },
        }
    }).mount('#app');
</script>

</body>
</html>