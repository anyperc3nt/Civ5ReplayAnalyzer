<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Civ5 Replay (PixiJS)</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- PixiJS 7 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', sans-serif; color: #eee; }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è PixiJS */
        #pixi-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        /* UI –°–ª–æ–π */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }

        /* –ü–∞–Ω–µ–ª–∏ */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            background: rgba(20, 20, 25, 0.9);
            border-bottom: 1px solid #444;
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .side-panel {
            position: absolute; top: 60px; right: 0; bottom: 0; width: 280px;
            background: rgba(20, 20, 25, 0.9);
            border-left: 1px solid #444;
            display: flex; flex-direction: column;
            overflow-y: auto;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã */
        button { background: #444; border: 1px solid #666; color: white; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
        button:hover { background: #555; }
        input[type=range] { width: 300px; }

        .stat-row { padding: 8px 12px; border-bottom: 1px solid #333; font-size: 13px; display: flex; justify-content: space-between; }
        .stat-row:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div id="app">
    <!-- –°—é–¥–∞ Pixi –¥–æ–±–∞–≤–∏—Ç Canvas -->
    <div id="pixi-container"></div>

    <!-- UI Vue.js -->
    <div id="ui-layer" v-if="loaded">
        <div class="top-bar interactive">
            <div>
                <b>Civ5 Replay</b> <span style="font-size: 0.8em; color: #888;">{{ currentTurnData?.timestamp ? new Date(currentTurnData.timestamp * 1000).toLocaleTimeString() : '' }}</span>
            </div>
            
            <div style="display: flex; gap: 10px; align-items: center;">
                <button @click="changeTurn(-1)">‚èÆ</button>
                <div style="width: 50px; text-align: center; font-size: 20px; font-weight: bold;">{{ currentTurn }}</div>
                <button @click="changeTurn(1)">‚è≠</button>
                <input type="range" min="0" :max="maxTurns" v-model.number="currentTurn" @input="updateMap">
            </div>

            <div style="margin-left: 20px; display: flex; gap: 5px;">
                <button @click="iconMode = 'default'" :style="{background: iconMode==='default'?'#66a':''}">All</button>
                <button @click="iconMode = 'military'" :style="{background: iconMode==='military'?'#66a':''}">‚öîÔ∏è</button>
                <button @click="iconMode = 'civilian'" :style="{background: iconMode==='civilian'?'#66a':''}">üë∑</button>
                <button @click="iconMode = 'resource'" :style="{background: iconMode==='resource'?'#66a':''}">üíé</button>
                <button @click="iconMode = 'misc'" :style="{background: iconMode==='misc'?'#66a':''}">üóø</button>
            </div>
        </div>

        <div class="side-panel interactive">
            <div style="padding: 10px; background: #333; font-weight: bold;">–ò–≥—Ä–æ–∫–∏</div>
            <div v-for="player in currentPlayers" :key="player.id" class="stat-row">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div :style="{width:'10px', height:'10px', borderRadius:'50%', background: getPlayerColor(player.id)}"></div>
                    Civ {{ player.id }}
                </div>
                <div>
                    <span style="color: gold;">{{ player.gold }}</span> | 
                    <span style="color: cyan;">+{{ player.science }}</span>
                </div>
            </div>

            <div style="padding: 10px; margin-top: 10px; background: #333; font-weight: bold;">–ì–æ—Ä–æ–¥–∞</div>
            <div v-for="city in currentCities" class="stat-row" @click="focusCity(city)" style="cursor: pointer;">
                <b>{{ city.name }}</b>
                <span>Pop: {{ city.pop }}</span>
            </div>
        </div>
    </div>
    
    <div v-else style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white;">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
    </div>

        <!-- –û–∫–Ω–æ –≥–æ—Ä–æ–¥–∞ -->
    <div v-if="selectedCity" class="side-panel interactive" style="left: 0; right: auto; border-right: 1px solid #444; border-left: none;">
        <div style="padding: 10px; background: #222; display: flex; justify-content: space-between;">
            <b>{{ selectedCity.name }}</b>
            <button @click="closeCity">X</button>
        </div>
        
        <div style="padding: 10px;">
            <div class="stat-row">–ù–∞—Å–µ–ª–µ–Ω–∏–µ: <span style="color:white">{{ selectedCity.pop }}</span></div>
            <div class="stat-row">–ó–¥–æ—Ä–æ–≤—å–µ: <span style="color:lime">{{ selectedCity.hp }}</span></div>
            
            <hr style="border-color: #444">
            
            <!-- YIELDS (–î–æ—Ö–æ–¥—ã) -->
            <div v-if="selectedCity.yields">
                <div class="stat-row">üçé –ï–¥–∞: <span>+{{ selectedCity.yields.food }}</span></div>
                <div class="stat-row">‚öôÔ∏è –ü—Ä–æ–∏–∑–≤: <span>+{{ selectedCity.yields.prod }}</span></div>
                <div class="stat-row">üí∞ –ó–æ–ª–æ—Ç–æ: <span>+{{ selectedCity.yields.gold }}</span></div>
                <div class="stat-row">üß™ –ù–∞—É–∫–∞: <span>+{{ selectedCity.yields.sci }}</span></div>
                <div class="stat-row">üéµ –ö—É–ª—å—Ç: <span>+{{ selectedCity.yields.cult }}</span></div>
                <div class="stat-row">üïäÔ∏è –í–µ—Ä–∞: <span>+{{ selectedCity.yields.faith }}</span></div>
            </div>

            <hr style="border-color: #444">

            <!-- –ü–†–û–ò–ó–í–û–î–°–¢–í–û -->
            <div style="text-align: center; margin-bottom: 10px; color: #aaa;">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ:</div>
            <div style="text-align: center; font-size: 1.1em; color: orange;">
                {{ selectedCity.prodItem || '–ù–∏—á–µ–≥–æ' }}
            </div>
            <div style="text-align: center; font-size: 0.9em;">
                (–û—Å—Ç–∞–ª–æ—Å—å —Ö–æ–¥–æ–≤: {{ selectedCity.prodTurns }})
            </div>

            <hr style="border-color: #444">
            
            <!-- –ó–î–ê–ù–ò–Ø -->
            <div style="margin-bottom: 5px; color: #aaa;">–ó–¥–∞–Ω–∏—è:</div>
            <div style="font-size: 0.85em; display: flex; flex-wrap: wrap; gap: 5px;">
                <span v-for="bId in selectedCity.buildings" :key="bId" style="background: #333; padding: 2px 5px; border-radius: 3px;">
                <!-- –¢—É—Ç –Ω—É–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è, –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ ID –∏–ª–∏ helper -->
                {{ getBuildingName(bId) }}
                </span>
            </div>
        </div>
    </div>

</div>


    
<script src="data.js"></script>
<script src="asset_map.js"></script>
<script src="js/viewer.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                loaded: false,
                currentTurn: 0,
                maxTurns: 0,
                replayData: null,
                selectedCityId: null, // –•—Ä–∞–Ω–∏–º ID, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç!
                
                // –†–µ–∂–∏–º—ã –∏–∫–æ–Ω–æ–∫: 'default', 'military', 'resource', 'civilian', 'misc'
                iconMode: 'default',
                
                playerColors: [0xda2020, 0x3366cc, 0xffcc00, 0x00aa00, 0xcc6600, 0x990099, 0x009999, 0xffffff]
            }
        },
        computed: {
            currentTurnData() { return this.replayData?.turns[this.currentTurn]; },
            currentPlayers() { return this.currentTurnData?.players || []; },
            
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏—â–µ–º –≥–æ—Ä–æ–¥ –≤ —Ç–µ–∫—É—â–µ–º —Ö–æ–¥—É –ø–æ ID
            selectedCity() {
                if (this.selectedCityId === null || !this.currentTurnData) return null;
                return this.currentTurnData.cities.find(c => c.id === this.selectedCityId);
            }
        },
        watch: {
            // –ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
            iconMode() {
                window.setIconMode(this.iconMode); // –ú–µ—Ç–æ–¥ –≤ viewer.js
                this.updateMap();
            }
        },
        mounted() {
            window.appVue = this;
            if (window.REPLAY_DATA) {
                this.replayData = window.REPLAY_DATA;
                this.maxTurns = this.replayData.turns.length - 1;
                window.initPixiApp(this.replayData);
                this.loaded = true;
            }
        },
        methods: {
            changeTurn(delta) {
                let next = this.currentTurn + delta;
                if (next >= 0 && next <= this.maxTurns) {
                    this.currentTurn = next;
                    this.updateMap();
                }
            },
            updateMap() {
                window.updatePixiTurn(this.currentTurn);
            },
            getPlayerColor(id) {
                if (id >= this.playerColors.length) return '#888888';
                return '#' + this.playerColors[id].toString(16).padStart(6, '0');
            },
            // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Pixi –ø—Ä–∏ –∫–ª–∏–∫–µ
            selectCity(cityId) {
                this.selectedCityId = cityId;
            },
            closeCity() {
                this.selectedCityId = null;
            },
            getBuildingName(id) {
                if (!this.replayData.header.dictionary.buildings) return id;
                let name = this.replayData.header.dictionary.buildings[id] || "Unknown";
                return name.replace("BUILDING_", "").replace(/_/g, " ");
            }
        }
    }).mount('#app');
</script>

</body>
</html>