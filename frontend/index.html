<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Civ5 Replay (PixiJS)</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- PixiJS 7 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', sans-serif; color: #eee; }
        
        /* Контейнер для PixiJS */
        #pixi-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        /* UI Слой */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }

        /* Панели */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            background: rgba(20, 20, 25, 0.9);
            border-bottom: 1px solid #444;
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .side-panel {
            position: absolute; top: 60px; right: 0; bottom: 0; width: 280px;
            background: rgba(20, 20, 25, 0.9);
            border-left: 1px solid #444;
            display: flex; flex-direction: column;
            overflow-y: auto;
        }

        /* Элементы */
        button { background: #444; border: 1px solid #666; color: white; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
        button:hover { background: #555; }
        input[type=range] { width: 300px; }

        .stat-row { padding: 8px 12px; border-bottom: 1px solid #333; font-size: 13px; display: flex; justify-content: space-between; }
        .stat-row:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div id="app">
    <!-- Сюда Pixi добавит Canvas -->
    <div id="pixi-container"></div>

    <!-- UI Vue.js -->
    <div id="ui-layer" v-if="loaded">
        <div class="top-bar interactive">
            <div>
                <b>Civ5 Replay</b> <span style="font-size: 0.8em; color: #888;">{{ currentTurnData?.timestamp ? new Date(currentTurnData.timestamp * 1000).toLocaleTimeString() : '' }}</span>
            </div>
            
            <div style="display: flex; gap: 10px; align-items: center;">
                <button @click="changeTurn(-1)">⏮</button>
                <div style="width: 50px; text-align: center; font-size: 20px; font-weight: bold;">{{ currentTurn }}</div>
                <button @click="changeTurn(1)">⏭</button>
                <input type="range" min="0" :max="maxTurns" v-model.number="currentTurn" @input="updateMap">
            </div>
        </div>

        <div class="side-panel interactive">
            <div style="padding: 10px; background: #333; font-weight: bold;">Игроки</div>
            <div v-for="player in currentPlayers" :key="player.id" class="stat-row">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <div :style="{width:'10px', height:'10px', borderRadius:'50%', background: getPlayerColor(player.id)}"></div>
                    Civ {{ player.id }}
                </div>
                <div>
                    <span style="color: gold;">{{ player.gold }}</span> | 
                    <span style="color: cyan;">+{{ player.science }}</span>
                </div>
            </div>

            <div style="padding: 10px; margin-top: 10px; background: #333; font-weight: bold;">Города</div>
            <div v-for="city in currentCities" class="stat-row" @click="focusCity(city)" style="cursor: pointer;">
                <b>{{ city.name }}</b>
                <span>Pop: {{ city.pop }}</span>
            </div>
        </div>
    </div>
    
    <div v-else style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white;">
        Загрузка данных...
    </div>
</div>

<script src="data.js"></script>
<script src="js/viewer.js"></script> <!-- Логика Pixi -->

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                loaded: false,
                currentTurn: 0,
                maxTurns: 0,
                replayData: null,
                playerColors: [0xff0000, 0x0000ff, 0x00ff00, 0xffff00, 0x00ffff, 0xff00ff, 0xffffff, 0x888888] // HEX числа для Pixi
            }
        },
        computed: {
            currentTurnData() { return this.replayData?.turns[this.currentTurn]; },
            currentPlayers() { return this.currentTurnData?.players || []; },
            currentCities() { return this.currentTurnData?.cities || []; }
        },
        mounted() {
            if (window.REPLAY_DATA) {
                this.replayData = window.REPLAY_DATA;
                this.maxTurns = this.replayData.turns.length - 1;
                
                // Инициализация Pixi
                window.initPixiApp(this.replayData);
                this.loaded = true;
            }
        },
        methods: {
            changeTurn(delta) {
                let next = this.currentTurn + delta;
                if (next >= 0 && next <= this.maxTurns) {
                    this.currentTurn = next;
                    this.updateMap();
                }
            },
            updateMap() {
                window.updatePixiTurn(this.currentTurn);
            },
            getPlayerColor(id) {
                // Конвертация 0xFF0000 -> #FF0000 для CSS
                return '#' + this.playerColors[id % this.playerColors.length].toString(16).padStart(6, '0');
            },
            focusCity(city) {
                window.moveCameraTo(city.x, city.y);
            }
        }
    }).mount('#app');
</script>

</body>
</html>