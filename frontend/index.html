<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Civ5 Replay (PixiJS)</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- PixiJS 7 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', sans-serif; color: #eee; }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è PixiJS */
        #pixi-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        /* UI –°–ª–æ–π */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .interactive { pointer-events: auto; }

        /* –ü–∞–Ω–µ–ª–∏ */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            background: rgba(20, 20, 25, 0.9);
            border-bottom: 1px solid #444;
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .side-panel {
            position: absolute; top: 60px; right: 0; bottom: 0; width: 280px;
            background: rgba(20, 20, 25, 0.9);
            border-left: 1px solid #444;
            display: flex; flex-direction: column;
            overflow-y: auto;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã */
        button { background: #444; border: 1px solid #666; color: white; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
        button:hover { background: #555; }
        input[type=range] { width: 300px; }

        .stat-row { padding: 8px 12px; border-bottom: 1px solid #333; font-size: 13px; display: flex; justify-content: space-between; }
        .stat-row:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div id="app">
    <!-- –°—é–¥–∞ Pixi –¥–æ–±–∞–≤–∏—Ç Canvas -->
    <div id="pixi-container"></div>

    <!-- UI Vue.js -->
    <div id="ui-layer" v-if="loaded">
        <div class="top-bar interactive">
            <div>
                <b>Civ5 Replay</b> <span style="font-size: 0.8em; color: #888;">{{ currentTurnData?.timestamp ? new Date(currentTurnData.timestamp * 1000).toLocaleTimeString() : '' }}</span>
            </div>

            <button @click="showTechTree = !showTechTree" :style="{background: showTechTree?'#4a4':''}">üß™ Tech</button>

            <div style="display: flex; gap: 10px; align-items: center;">
                <button @click="changeTurn(-1)">‚èÆ</button>
                <div style="width: 50px; text-align: center; font-size: 20px; font-weight: bold;">{{ currentTurn }}</div>
                <button @click="changeTurn(1)">‚è≠</button>
                <input type="range" min="0" :max="maxTurns" v-model.number="currentTurn" @input="updateMap">
            </div>

            <div style="margin-left: 20px; display: flex; gap: 5px;">
                <button @click="iconMode = 'default'" :style="{background: iconMode==='default'?'#66a':''}">All</button>
                <button @click="iconMode = 'military'" :style="{background: iconMode==='military'?'#66a':''}">‚öîÔ∏è</button>
                <button @click="iconMode = 'civilian'" :style="{background: iconMode==='civilian'?'#66a':''}">üë∑</button>
                <button @click="iconMode = 'resource'" :style="{background: iconMode==='resource'?'#66a':''}">üíé</button>
                <button @click="iconMode = 'misc'" :style="{background: iconMode==='misc'?'#66a':''}">üóø</button>
            </div>
        </div>

        <div class="side-panel interactive">
            <div style="padding: 10px; background: #333; font-weight: bold; border-bottom: 1px solid #555;">
                –ò–≥—Ä–æ–∫–∏
            </div>
            
            <!-- –°–ü–ò–°–û–ö –ò–ì–†–û–ö–û–í -->
            <div v-for="player in visiblePlayers" :key="player.id" class="stat-row">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <!-- –¶–≤–µ—Ç–Ω–æ–π –∫—Ä—É–∂–æ–∫ -->
                    <div :style="{
                        width:'14px', height:'14px', 
                        borderRadius:'50%', 
                        background: getPlayerColor(player.id),
                        border: '1px solid rgba(255,255,255,0.3)'
                    }"></div>
                    
                    <!-- –ò–º—è + –°—Ç–∞—Ç—É—Å -->
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: bold; font-size: 0.95em;">
                            {{ getCivilizationName(player.id) }}
                        </span>
                        <span style="font-size: 0.75em; color: #aaa;" v-if="!player.isAlive">ELIMINATED</span>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç—ã (–≤ —Å—Ç–æ–ª–±–∏–∫ –∏–ª–∏ —Å—Ç—Ä–æ–∫—É) -->
                <div style="text-align: right; font-size: 0.85em; display: flex; flex-direction: column;">
                    <span style="color: gold;">üí∞ {{ Math.floor(player.gold) }} <small>({{ player.goldPerTurn > 0 ? '+' : ''}}{{ player.goldPerTurn }})</small></span>
                    <span style="color: cyan;">üß™ {{ player.science }}</span>
                    <span style="color: #d0f;">üéµ {{ Math.floor(player.totalCulture) }}</span>
                </div>
            </div>

            <div style="padding: 10px; margin-top: 10px; background: #333; font-weight: bold;">–ì–æ—Ä–æ–¥–∞</div>
            <div v-for="city in currentCities" class="stat-row" @click="selectCity(city.id, city.owner)" style="cursor: pointer;">
                <b>{{ city.name }}</b>
                <span>Pop: {{ city.pop }}</span>
            </div>
        </div>
        <!-- TECH TREE MODAL -->
        <div v-if="showTechTree" class="interactive" style="
        position: absolute; top: 60px; left: 0; right: 0; bottom: 0; 
        background: rgba(10,12,16, 0.95); 
        overflow: auto; /* –°–∫—Ä–æ–ª–ª */
        z-index: 50;
        ">
        <div style="position: relative; width: 4000px; height: 1000px; padding: 50px;">

            <!-- –õ–ï–ì–ï–ù–î–ê (–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–ª–∞—à–∫–∞ —Å–≤–µ—Ä—Ö—É –∏–ª–∏ —Å–±–æ–∫—É) -->
            <div style="position: sticky; top: 10px; left: 10px; z-index: 100; display: flex; gap: 10px; pointer-events: none;">
                <div v-for="p in visiblePlayers.filter(x=>!x.isMinor)" :key="p.id" 
                     style="background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 4px; border: 1px solid #555; display: flex; align-items: center; gap: 5px;">
                    <div :style="{width:'10px', height:'10px', background: getPlayerColor(p.id)}"></div>
                    <span style="font-size: 12px; color: #fff;">{{ getCivilizationName(p.id) }}</span>
                </div>
            </div>
            
            <!-- 1. –°–õ–û–ô –°–í–Ø–ó–ï–ô (SVG) -->
            <svg style="position: absolute; top:0; left:0; width: 100%; height: 100%; pointer-events: none;">
                <path v-for="(link, i) in techTreeLinks" :key="i"
                    :d="`M ${link.x1} ${link.y1} C ${link.x1+30} ${link.y1}, ${link.x2-30} ${link.y2}, ${link.x2} ${link.y2}`"
                    stroke="#555" stroke-width="2" fill="none" />
            </svg>

            <!-- 2. –°–õ–û–ô –ö–ê–†–¢–û–ß–ï–ö -->
            <div v-for="node in techTreeNodes" :key="node.id" 
                 :style="{
                    position: 'absolute',
                    left: node.x + 'px',
                    top: node.y + 'px',
                    width: '180px',
                    height: '60px',
                    background: '#222',
                    border: '1px solid #444',
                    borderRadius: '4px',
                    padding: '4px',
                    fontSize: '11px',
                    color: '#eee',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.5)',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'space-between'
                 }">
                
                <!-- –í–µ—Ä—Ö: –ù–∞–∑–≤–∞–Ω–∏–µ –∏ –¶–µ–Ω–∞ -->
                <div style="display: flex; justify-content: space-between;">
                    <div style="font-weight: bold; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 130px;" :title="node.name">
                        {{ node.name }}
                    </div>
                    <div style="color: #888; font-size: 10px;">{{ node.cost }}</div>
                </div>

                <!-- –ù–∏–∑: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏–≥—Ä–æ–∫–æ–≤ (–ß–∏–ø—ã) -->
                <div style="display: flex; gap: 2px; height: 12px; margin-top: auto;">
                    <div v-for="ps in node.playerStatuses" :key="ps.id" 
                         :title="getCivilizationName(ps.id) + ': ' + ps.status"
                         :style="{
                            flex: 1,
                            borderRadius: '2px',
                            // –õ–û–ì–ò–ö–ê –¶–í–ï–¢–û–í
                            background: ps.status === 'researched' ? ps.color : 
                                        ps.status === 'current' ? 'transparent' : '#333',
                            
                            border: ps.status === 'current' ? ('2px solid ' + ps.color) : 
                                    ps.status === 'none' ? '1px solid #333' : '1px solid ' + ps.color,
                            
                            opacity: ps.status === 'none' ? 0.3 : 1
                         }">
                    </div>
                </div>

            </div>

        </div>
        </div>  
    </div>
    
    <div v-else style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); color:white;">
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
    </div>

        <!-- –û–∫–Ω–æ –≥–æ—Ä–æ–¥–∞ -->
    <div v-if="selectedCity" class="side-panel interactive" style="left: 0; right: auto; border-right: 1px solid #444; border-left: none;">
        <div style="padding: 10px; background: #222; display: flex; justify-content: space-between;">
            <b>{{ selectedCity.name }}</b>
            <button @click="closeCity">X</button>
        </div>
        
        <div style="padding: 10px;">
            <div class="stat-row">–ù–∞—Å–µ–ª–µ–Ω–∏–µ: <span style="color:white">{{ selectedCity.pop }}</span></div>
            <div class="stat-row">–ó–¥–æ—Ä–æ–≤—å–µ: <span style="color:lime">{{ selectedCity.hp }}</span></div>
            
            <!-- –ù–û–í–û–ï: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ–∫—É—Å–∞ -->
            <div class="stat-row">
                üéØ –§–æ–∫—É—Å: 
                <span style="color: cyan; font-weight: bold;">
                    {{ getFocusName(selectedCity.focus) }}
                </span>
            </div>

            <hr style="border-color: #444">
            
            <!-- YIELDS (–î–æ—Ö–æ–¥—ã) -->
            <div v-if="selectedCity.yields">
                <div class="stat-row">üçé –ï–¥–∞: <span>+{{ selectedCity.yields.food }}</span></div>
                <div class="stat-row">‚öôÔ∏è –ü—Ä–æ–∏–∑–≤: <span>+{{ selectedCity.yields.prod }}</span></div>
                <div class="stat-row">üí∞ –ó–æ–ª–æ—Ç–æ: <span>+{{ selectedCity.yields.gold }}</span></div>
                <div class="stat-row">üß™ –ù–∞—É–∫–∞: <span>+{{ selectedCity.yields.sci }}</span></div>
                <div class="stat-row">üéµ –ö—É–ª—å—Ç: <span>+{{ selectedCity.yields.cult }}</span></div>
                <div class="stat-row">üïäÔ∏è –í–µ—Ä–∞: <span>+{{ selectedCity.yields.faith }}</span></div>
            </div>

            <hr style="border-color: #444">
            <hr style="border-color: #444">

            <!-- –°–ü–ï–¶–ò–ê–õ–ò–°–¢–´ -->
            <div style="margin-bottom: 5px; color: #aaa;">–ì—Ä–∞–∂–¥–∞–Ω–µ:</div>
            
            <!-- –ë–µ–∑–¥–µ–ª—å–Ω–∏–∫–∏ -->
            <div v-if="selectedCity.slackers > 0" class="stat-row">
                üî¥ –ë–µ–∑—Ä–∞–±–æ—Ç–Ω—ã–µ: <span style="font-weight:bold;">{{ selectedCity.slackers }}</span>
            </div>

            <!-- –ó–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã -->
            <div v-if="selectedCity.specSlots && selectedCity.specSlots.length > 0">
                <div v-for="slot in selectedCity.specSlots" :key="slot.b" style="font-size: 0.9em; padding: 2px 0;">
                    <!-- –ò–º—è –∑–¥–∞–Ω–∏—è + –∫–æ–ª-–≤–æ —Å–ø–µ—Ü–æ–≤ -->
                    üèõÔ∏è {{ getBuildingName(slot.b) }}: 
                    <span style="color: yellow;">{{ slot.c }} üë§</span>
                </div>
            </div>

            <!-- –ü–†–û–ì–†–ï–°–° –í–ï–õ–ò–ö–ò–• –õ–Æ–î–ï–ô -->
            <div v-if="selectedCity.gpProgress && selectedCity.gpProgress.length > 0" style="margin-top: 10px;">
                <div style="color: #aaa; margin-bottom: 2px;">–í–µ–ª–∏–∫–∏–µ –ª—é–¥–∏:</div>
                <div v-for="gp in selectedCity.gpProgress" :key="gp.s" style="font-size: 0.8em; margin-bottom: 4px;">
                    <!-- –¢—É—Ç –º–æ–∂–Ω–æ –º–∞–ø–ø–∏—Ç—å ID —Å–ø–µ—Ü–∞ –Ω–∞ –∏–º—è, –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ ID -->
                    Spec {{ gp.s }}: 
                    <div style="background: #444; height: 4px; width: 100%; margin-top: 2px;">
                        <div :style="{width: (gp.p / gp.t * 100) + '%', background: 'cyan', height: '100%'}"></div>
                    </div>
                    <div style="text-align: right; color: #888;">{{ gp.p }} / {{ gp.t }}</div>
                </div>
            </div>
            <!-- –ü–†–û–ò–ó–í–û–î–°–¢–í–û -->
            <div style="text-align: center; margin-bottom: 10px; color: #aaa;">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ:</div>
            <div style="text-align: center; font-size: 1.1em; color: orange;">
                {{ selectedCity.prodItem || '–ù–∏—á–µ–≥–æ' }}
            </div>
            <div style="text-align: center; font-size: 0.9em;">
                (–û—Å—Ç–∞–ª–æ—Å—å —Ö–æ–¥–æ–≤: {{ selectedCity.prodTurns }})
            </div>

            <hr style="border-color: #444">
            
            <!-- –ó–î–ê–ù–ò–Ø -->
            <div style="margin-bottom: 5px; color: #aaa;">–ó–¥–∞–Ω–∏—è:</div>
            <div style="font-size: 0.85em; display: flex; flex-wrap: wrap; gap: 5px;">
                <span v-for="bId in selectedCity.buildings" :key="bId" style="background: #333; padding: 2px 5px; border-radius: 3px;">
                <!-- –¢—É—Ç –Ω—É–∂–Ω–æ –ø–æ–¥—Ç—è–Ω—É—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è, –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ ID –∏–ª–∏ helper -->
                {{ getBuildingName(bId) }}
                </span>
            </div>
        </div>
    </div>

</div>


    
<script src="data.js"></script>
<script src="asset_map.js"></script>
<script src="js/viewer.js"></script>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                loaded: false,
                currentTurn: 0,
                maxTurns: 0,
                replayData: null,
                selectedCityId: null, // –•—Ä–∞–Ω–∏–º ID, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç!
                selectedCityOwner: null, // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
                
                // –†–µ–∂–∏–º—ã –∏–∫–æ–Ω–æ–∫: 'default', 'military', 'resource', 'civilian', 'misc'
                iconMode: 'default',

                showTechTree: false, // –û—Ç–∫—Ä—ã—Ç–æ –ª–∏ –æ–∫–Ω–æ
                techTreeScale: 1,    // –ó—É–º –¥–µ—Ä–µ–≤–∞ (–µ—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏–º)
                
                playerColors: [0xda2020, 0x3366cc, 0xffcc00, 0x00aa00, 0xcc6600, 0x990099, 0x009999, 0xffffff]
            }
        },
        computed: {
            currentTurnData() { return this.replayData?.turns[this.currentTurn]; },
            currentPlayers() { return this.currentTurnData?.players || []; },

                // –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù–ù–´–ô –°–ü–ò–°–û–ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∞–Ω–µ–ª–∏
            visiblePlayers() {
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–∞—Å—Å–∏–≤ –µ—Å—Ç—å
                if (!this.currentPlayers) return [];
                // 2. –§–∏–ª—å—Ç—Ä—É–µ–º: –ò–≥—Ä–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ò —ç—Ç–æ –Ω–µ –í–∞—Ä–≤–∞—Ä
                return this.currentPlayers.filter(p => p && !p.isBarbarian);
            },
            
            selectedCity() {
                if (this.selectedCityId === null || !this.currentTurnData) return null;
                return this.currentTurnData.cities.find(c => 
                    c.id === this.selectedCityId && 
                    c.owner === this.selectedCityOwner
                );
            },
            techTreeNodes() {
                if (!this.replayData) return [];
                const techs = this.replayData.header.dictionary.technologies;
                const nodes = [];
                
                const CELL_W = 220; 
                const CELL_H = 80;
                
                // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–∞–∂–æ—Ä–Ω—ã—Ö —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–π (–¥–ª—è –ø–æ—Ä—è–¥–∫–∞ —Å–ª–æ—Ç–æ–≤)
                // –§–∏–ª—å—Ç—Ä—É–µ–º: —Å—É—â–µ—Å—Ç–≤—É—é—Ç, –Ω–µ –≤–∞—Ä–≤–∞—Ä—ã, –Ω–µ –ì–ì
                const majorPlayers = this.currentPlayers.filter(p => p && !p.isBarbarian && !p.isMinor);

                Object.keys(techs).forEach(key => {
                    const t = techs[key];
                    const techID = parseInt(key);
                    
                    // 2. –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞–∂–æ—Ä–∞
                    const playerStatuses = majorPlayers.map(p => {
                        let status = 'none'; // 'none', 'researched', 'current'
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ (p.tech –º–æ–∂–µ—Ç –±—ã—Ç—å null –≤ —Ä–∞–Ω–Ω–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –ª–æ–≥–≥–µ—Ä–∞)
                        if (p.tech) {
                            // –ê. –£–∂–µ –∏–∑—É—á–µ–Ω–æ
                            if (p.tech.researched && p.tech.researched.includes(techID)) {
                                status = 'researched';
                            }
                            // –ë. –ò–∑—É—á–∞–µ—Ç—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
                            else if (p.tech.current === techID) {
                                status = 'current';
                            }
                        }
                        
                        return {
                            id: p.id,
                            color: this.getPlayerColor(p.id),
                            status: status
                        };
                    });

                    nodes.push({
                        id: techID,
                        name: t.name,
                        cost: t.cost,
                        x: t.gridX * CELL_W, 
                        y: t.gridY * CELL_H, 
                        prereqs: t.prereqs,
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤ —É–∑–µ–ª
                        playerStatuses: playerStatuses
                    });
                });
                
                return nodes;
            },
        
            // –°–≤—è–∑–∏ (–°—Ç—Ä–µ–ª–æ—á–∫–∏)
            techTreeLinks() {
                const links = [];
                const nodesMap = {};
                this.techTreeNodes.forEach(n => nodesMap[n.id] = n);
                
                const BOX_W = 180; // –®–∏—Ä–∏–Ω–∞ —Å–∞–º–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ (–º–µ–Ω—å—à–µ CELL_W)
                const BOX_H = 60;  // –í—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
                
                this.techTreeNodes.forEach(target => {
                    if (target.prereqs) {
                        target.prereqs.forEach(parentId => {
                            const source = nodesMap[parentId];
                            if (source) {
                                links.push({
                                    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è SVG –ª–∏–Ω–∏–∏
                                    x1: source.x + BOX_W, // –í—ã—Ö–æ–¥ —Å–ø—Ä–∞–≤–∞
                                    y1: source.y + BOX_H/2, // –°–µ—Ä–µ–¥–∏–Ω–∞ –≤—ã—Å–æ—Ç—ã
                                    x2: target.x,         // –í—Ö–æ–¥ —Å–ª–µ–≤–∞
                                    y2: target.y + BOX_H/2
                                });
                            }
                        });
                    }
                });
                return links;
            }
        },
        watch: {
            // –ü—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
            iconMode() {
                window.setIconMode(this.iconMode); // –ú–µ—Ç–æ–¥ –≤ viewer.js
                this.updateMap();
            }
        },
        mounted() {
            window.appVue = this;
            if (window.REPLAY_DATA) {
                this.replayData = window.REPLAY_DATA;
                this.maxTurns = this.replayData.turns.length - 1;
                window.initPixiApp(this.replayData);
                this.loaded = true;
            }
        },
        methods: {
            changeTurn(delta) {
                let next = this.currentTurn + delta;
                if (next >= 0 && next <= this.maxTurns) {
                    this.currentTurn = next;
                    this.updateMap();
                }
            },
            updateMap() {
                window.updatePixiTurn(this.currentTurn);
            },
            getPlayerColor(id) {
                if (id >= this.playerColors.length) return '#888888';
                return '#' + this.playerColors[id].toString(16).padStart(6, '0');
            },
            selectCity(cityId, ownerId) {
                this.selectedCityId = cityId;
                this.selectedCityOwner = ownerId;
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞
                if (this.selectedCity && window.highlightWorkedPlots) {
                    const ownerColor = parseInt(this.getPlayerColor(this.selectedCity.owner).replace('#', ''), 16);
                    
                    // !!! –ü–ï–†–ï–î–ê–ï–ú locked –ú–ê–°–°–ò–í –í–¢–û–†–´–ú –ê–†–ì–£–ú–ï–ù–¢–û–ú
                    // (–∏—Å–ø–æ–ª—å–∑—É–µ–º || [] –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ –≤ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å—è—Ö)
                    window.highlightWorkedPlots(
                        this.selectedCity.worked || [], 
                        this.selectedCity.locked || [], 
                        ownerColor
                    );
                }
            },
            closeCity() {
                this.selectedCityId = null;
                this.selectedCityOwner = null;
                if (window.highlightWorkedPlots) window.highlightWorkedPlots([], [], 0);
            },
            getBuildingName(id) {
                if (!this.replayData.header.dictionary.buildings) return id;
                let name = this.replayData.header.dictionary.buildings[id] || "Unknown";
                return name.replace("BUILDING_", "").replace(/_/g, " ");
            },
            getCivilizationName(playerId) {
                if (playerId === 63) return "Barbarians";
                
                // –ò—â–µ–º –∏–≥—Ä–æ–∫–∞ –≤ —Ç–µ–∫—É—â–µ–º —Ö–æ–¥–µ
                const p = this.currentPlayers.find(pl => pl.id === playerId);
                if (!p) return `Player ${playerId}`;

                // –ï—Å–ª–∏ –µ—Å—Ç—å civName (Description), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                if (p.civName) return p.civName;

                // –§–æ–ª–±–µ–∫ –Ω–∞ —Å–ª–æ–≤–∞—Ä—å (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ civName –ø—É—Å—Ç–æ–π, –±–µ—Ä–µ–º Type –∏–∑ —Å–ª–æ–≤–∞—Ä—è)
                // –ù–æ p.civName (–∏–∑ Lua p:GetCivilizationDescription()) –æ–±—ã—á–Ω–æ –Ω–∞–¥–µ–∂–Ω–µ–µ
                return `Civ ${playerId}`;
            },
            getFocusName(focusId) {
                // –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–≤–æ–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è (CityAIFocusTypes Enum)
                const modes = {
                    '-1': "Default",        // NO_FOCUS
                    0: "Food üçé",           // FOOD
                    1: "Production ‚öôÔ∏è",     // PRODUCTION
                    2: "Gold üí∞",           // GOLD
                    3: "Great People üåü",   // GREAT_PEOPLE (—Å–¥–≤–∏–Ω—É–ª—Å—è —Å—é–¥–∞)
                    4: "Science üß™",        // SCIENCE
                    5: "Culture üéµ",        // CULTURE
                    8: "Faith üïäÔ∏è"           // FAITH
                };
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö ID (6 –∏–ª–∏ 7, –µ—Å–ª–∏ –æ–Ω–∏ –≤–¥—Ä—É–≥ –ø–æ—è–≤—è—Ç—Å—è)
                return modes[focusId] || `Unknown (${focusId})`;
            },
        }
    }).mount('#app');
</script>

</body>
</html>