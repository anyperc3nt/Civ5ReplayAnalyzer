<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Civ5 Analyzer</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Vue 3 –∏ Chart.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; color: #eee; }
        
        /* –°–ª–æ–π –∫–∞—Ä—Ç—ã (–Ω–∞ —Ñ–æ–Ω–µ) */
        #mapCanvas { position: absolute; top: 0; left: 0; z-index: 0; }

        /* UI –°–ª–æ–π (–ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã) */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        /* –†–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .interactive { pointer-events: auto; }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            background: rgba(30, 33, 40, 0.9);
            padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #444;
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (–°–ø–∏—Å–∫–∏) */
        .side-panel {
            position: absolute; top: 60px; right: 0; bottom: 0;
            width: 300px;
            background: rgba(30, 33, 40, 0.85);
            border-left: 1px solid #444;
            display: flex; flex-direction: column;
            overflow-y: auto;
        }

        /* –°—Ç–∏–ª—å –ø–æ–ª–∑—É–Ω–∫–∞ */
        input[type=range] { width: 300px; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        button {
            background: #3a738c; border: none; color: white;
            padding: 5px 15px; border-radius: 4px; cursor: pointer;
        }
        button:hover { background: #4a93b0; }

        /* –¢–∞–±–ª–∏—Ü—ã –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
        .stat-row { display: flex; justify-content: space-between; padding: 5px 10px; border-bottom: 1px solid #333; font-size: 14px; }
        .stat-row:hover { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div id="app">
    <!-- –ö–∞—Ä—Ç–∞ -->
    <canvas id="mapCanvas"></canvas>

    <!-- UI -->
    <div id="ui-layer" v-if="loaded">
        
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å: –¢–∞–π–º–ª–∞–π–Ω -->
        <div class="top-bar interactive">
            <div style="font-weight: bold; font-size: 18px;">Civ5 Replay</div>
            
            <div style="display: flex; align-items: center; gap: 15px;">
                <button @click="changeTurn(-1)">‚óÄ</button>
                <div style="text-align: center; min-width: 80px;">
                    <div style="font-size: 12px; color: #aaa;">–•–û–î</div>
                    <div style="font-size: 20px;">{{ currentTurn }}</div>
                </div>
                <button @click="changeTurn(1)">‚ñ∂</button>
                
                <input type="range" min="0" :max="maxTurns" v-model.number="currentTurn" @input="onSliderChange">
            </div>

            <div style="font-size: 14px;">
                {{ timestampToDate(currentTurnData?.timestamp) }}
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="side-panel interactive">
            <div style="padding: 10px; background: #2a2a2a; font-weight: bold;">–ò–≥—Ä–æ–∫–∏</div>
            
            <div v-for="player in currentPlayers" :key="player.id" class="stat-row">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <!-- –¶–≤–µ—Ç–Ω–æ–π –∫—Ä—É–∂–æ–∫ –∏–≥—Ä–æ–∫–∞ -->
                    <div :style="{width: '10px', height: '10px', borderRadius: '50%', background: getPlayerColor(player.id)}"></div>
                    <span>–ò–≥—Ä–æ–∫ {{ player.id }}</span>
                </div>
                <div style="text-align: right;">
                    <div style="color: gold;">{{ player.gold }} üí∞</div>
                    <div style="color: cyan;">+{{ player.science }} üß™</div>
                </div>
            </div>

            <div style="padding: 10px; margin-top: 20px; background: #2a2a2a; font-weight: bold;">–ì–æ—Ä–æ–¥–∞ ({{ currentCities.length }})</div>
            <div v-for="city in currentCities" class="stat-row" @click="focusCity(city)" style="cursor: pointer;">
                <div>{{ city.name }}</div>
                <div>Pop: {{ city.pop }}</div>
            </div>
        </div>
    </div>
    
    <div v-else style="color: white; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
</div>

<!-- –î–∞–Ω–Ω—ã–µ -->
<script src="data.js"></script>

<!-- –õ–æ–≥–∏–∫–∞ -->
<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                loaded: false,
                currentTurn: 0,
                maxTurns: 0,
                replayData: null,
                // –¶–≤–µ—Ç–∞ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤
                playerColors: ["#f00", "#00f", "#0f0", "#ff0", "#0ff", "#f0f", "#fff", "#888"]
            }
        },
        computed: {
            currentTurnData() {
                if (!this.replayData) return null;
                return this.replayData.turns[this.currentTurn];
            },
            currentPlayers() {
                return this.currentTurnData ? this.currentTurnData.players : [];
            },
            currentCities() {
                return this.currentTurnData ? this.currentTurnData.cities : [];
            }
        },
        mounted() {
            if (window.REPLAY_DATA) {
                this.replayData = window.REPLAY_DATA;
                this.maxTurns = this.replayData.turns.length - 1;
                this.loaded = true;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É (—Ñ—É–Ω–∫—Ü–∏—è –∏–∑ viewer.js, –∫–æ—Ç–æ—Ä—É—é –º—ã –∞–¥–∞–ø—Ç–∏—Ä—É–µ–º)
                this.$nextTick(() => {
                    window.initMap(this.replayData); // –ú—ã –ø–µ—Ä–µ–¥–µ–ª–∞–µ–º viewer.js –ø–æ–¥ —ç—Ç–æ
                });
            } else {
                alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö data.js");
            }
        },
        methods: {
            changeTurn(delta) {
                let newTurn = this.currentTurn + delta;
                if (newTurn >= 0 && newTurn <= this.maxTurns) {
                    this.currentTurn = newTurn;
                    this.updateMap();
                }
            },
            onSliderChange() {
                this.updateMap();
            },
            updateMap() {
                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
                if (window.setMapTurn) window.setMapTurn(this.currentTurn);
            },
            timestampToDate(ts) {
                if (!ts) return "";
                return new Date(ts * 1000).toLocaleTimeString();
            },
            getPlayerColor(id) {
                return this.playerColors[id % this.playerColors.length];
            },
            focusCity(city) {
                // –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É –∫ –≥–æ—Ä–æ–¥—É
                if (window.moveCameraTo) window.moveCameraTo(city.x, city.y);
            }
        }
    }).mount('#app');
</script>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à —Å–∫—Ä–∏–ø—Ç –∫–∞—Ä—Ç—ã -->
<script src="js/viewer.js"></script>

</body>
</html>